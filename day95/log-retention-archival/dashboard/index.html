<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Log Retention & Archival Dashboard</title>
  <style>
    * { margin: 0; padding: 0; box-sizing: border-box; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f0f2f5; min-height: 100vh; }
    .header { background: #001529; color: #fff; padding: 16px 24px; font-size: 20px; font-weight: bold; }
    .layout { display: flex; min-height: calc(100vh - 56px); }
    .sidebar { width: 220px; background: #fff; border-right: 1px solid #f0f0f0; padding: 16px 0; }
    .sidebar a { display: block; padding: 12px 24px; color: #333; text-decoration: none; }
    .sidebar a:hover { background: #f5f5f5; }
    .sidebar a.active { background: #e6f7ff; color: #1890ff; border-right: 3px solid #1890ff; }
    .main { flex: 1; padding: 24px; overflow: auto; }
    .card { background: #fff; border-radius: 8px; padding: 24px; margin-bottom: 16px; box-shadow: 0 1px 2px rgba(0,0,0,0.03); }
    .card h3 { margin-bottom: 16px; font-size: 16px; }
    .stats { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; margin-bottom: 24px; }
    .stat { background: #fff; padding: 20px; border-radius: 8px; box-shadow: 0 1px 2px rgba(0,0,0,0.03); }
    .stat .label { color: #8c8c8c; font-size: 14px; margin-bottom: 8px; }
    .stat .value { font-size: 24px; font-weight: 600; }
    .stat.hot .value { color: #52c41a; }
    .stat.warm .value { color: #1890ff; }
    .stat.cold .value { color: #faad14; }
    .stat.cost .value { color: #f5222d; }
    .actions { margin: 16px 0; }
    .btn { padding: 8px 16px; margin-right: 8px; border-radius: 4px; border: 1px solid #d9d9d9; background: #fff; cursor: pointer; font-size: 14px; }
    .btn.primary { background: #1890ff; color: #fff; border-color: #1890ff; }
    .btn:disabled { opacity: 0.6; cursor: not-allowed; }
    table { width: 100%; border-collapse: collapse; font-size: 13px; }
    th, td { padding: 8px 12px; text-align: left; border-bottom: 1px solid #f0f0f0; }
    th { background: #fafafa; font-weight: 600; }
    .tag { display: inline-block; padding: 2px 8px; border-radius: 4px; font-size: 12px; }
    .tag.green { background: #f6ffed; color: #52c41a; }
    .tag.blue { background: #e6f7ff; color: #1890ff; }
    .tag.orange { background: #fff7e6; color: #faad14; }
    .tag.red { background: #fff2f0; color: #f5222d; }
    .hint { background: #e6f7ff; border: 1px solid #91d5ff; border-radius: 8px; padding: 12px; margin-bottom: 16px; }
    .error { background: #fff2f0; border: 1px solid #ffccc7; border-radius: 8px; padding: 12px; margin-bottom: 16px; color: #cf1322; }
    .page { display: none; }
    .page.active { display: block; }
  </style>
</head>
<body>
  <div class="header">Log Retention & Archival Dashboard</div>
  <div class="layout">
    <nav class="sidebar">
      <a href="#" class="active" data-page="overview">Overview</a>
      <a href="#" data-page="logs">Log Entries</a>
      <a href="#" data-page="jobs">Archival Jobs</a>
      <a href="#" data-page="policies">Retention Policies</a>
      <a href="#" data-page="costs">Cost Analysis</a>
    </nav>
    <main class="main">
      <div id="error" class="error" style="display:none;"></div>
      <div style="margin-bottom:12px;font-size:13px;color:#666;"><span id="last-updated"></span> <button class="btn" id="btn-refresh" style="margin-left:12px;">Refresh</button></div>
      <div id="overview" class="page active">
        <div class="hint" id="empty-hint" style="display:none;">No data yet. Click "Generate Sample Logs" below to populate the dashboard.</div>
        <div class="stats">
          <div class="stat hot"><div class="label">Hot Storage</div><div class="value" id="hot-count">0</div><div class="label">logs · <span id="hot-mb">0</span> MB</div></div>
          <div class="stat warm"><div class="label">Warm Storage</div><div class="value" id="warm-count">0</div><div class="label">logs · <span id="warm-mb">0</span> MB</div></div>
          <div class="stat cold"><div class="label">Cold Storage</div><div class="value" id="cold-count">0</div><div class="label">logs · <span id="cold-mb">0</span> MB</div></div>
          <div class="stat cost"><div class="label">Total Cost</div><div class="value" id="total-cost">$0</div><div class="label">/ month · <span id="total-gb">0</span> GB</div></div>
        </div>
        <div class="card">
          <h3>Quick Actions</h3>
          <div class="actions">
            <button class="btn primary" id="btn-generate">Generate Sample Logs</button>
            <button class="btn" id="btn-evaluate">Evaluate Retention</button>
          </div>
        </div>
      </div>
      <div id="logs" class="page">
        <div class="card"><h3>Log Entries</h3><table id="logs-table"><thead><tr><th>Source</th><th>Level</th><th>Message</th><th>Tier</th><th>Timestamp</th></tr></thead><tbody></tbody></table></div>
      </div>
      <div id="jobs" class="page">
        <div class="card"><h3>Archival Jobs</h3><table id="jobs-table"><thead><tr><th>ID</th><th>Type</th><th>Status</th><th>Transition</th><th>Logs</th><th>Started</th></tr></thead><tbody></tbody></table></div>
      </div>
      <div id="policies" class="page">
        <div class="card"><h3>Retention Policies</h3><table id="policies-table"><thead><tr><th>Name</th><th>Hot (days)</th><th>Warm (days)</th><th>Cold (days)</th><th>Enabled</th></tr></thead><tbody></tbody></table></div>
      </div>
      <div id="costs" class="page">
        <div class="card"><h3>Cost Breakdown</h3><table id="costs-table"><thead><tr><th>Tier</th><th>Logs</th><th>Size (GB)</th><th>Monthly Cost</th></tr></thead><tbody></tbody></table></div>
      </div>
    </main>
  </div>
  <script>
    // Use same host as dashboard so it works from any URL (localhost, 127.0.0.1, or hostname)
    const API = 'http://' + (window.location.hostname || 'localhost') + ':8000';
    let data = { stats: {}, costs: {}, logs: [], jobs: [], policies: [] };
    let lastUpdated = null;
    let autoLoadDone = false;

    async function fetchAll() {
      try {
        const [s, c, l, j, p] = await Promise.all([
          fetch(API + '/logs/stats').then(r => r.ok ? r.json() : {}),
          fetch(API + '/costs').then(r => r.ok ? r.json() : {}),
          fetch(API + '/logs?limit=50').then(r => r.ok ? r.json() : []),
          fetch(API + '/jobs?limit=20').then(r => r.ok ? r.json() : []),
          fetch(API + '/policies').then(r => r.ok ? r.json() : [])
        ]);
        data = { stats: s, costs: c, logs: Array.isArray(l) ? l : [], jobs: Array.isArray(j) ? j : [], policies: Array.isArray(p) ? p : [] };
        lastUpdated = new Date();
        document.getElementById('error').style.display = 'none';
        render();

        // Auto-load sample data once when backend is reachable but has no logs
        const total = (s.hot && s.hot.count) + (s.warm && s.warm.count) + (s.cold && s.cold.count) || 0;
        if (total === 0 && !autoLoadDone) {
          autoLoadDone = true;
          try {
            await fetch(API + '/logs/generate?count=100', { method: 'POST' });
            await fetchAll();
          } catch (e) { autoLoadDone = false; }
        }
      } catch (e) {
        document.getElementById('error').textContent = 'Cannot reach backend at ' + API + '. Run: cd log-retention-archival && docker compose up -d backend — wait ~15s then click Refresh.';
        document.getElementById('error').style.display = 'block';
      }
    }

    function render() {
      const st = data.stats || {};
      const co = data.costs || {};
      const hotCount = (st.hot && st.hot.count) ?? 0;
      const warmCount = (st.warm && st.warm.count) ?? 0;
      const coldCount = (st.cold && st.cold.count) ?? 0;
      document.getElementById('hot-count').textContent = hotCount;
      document.getElementById('hot-mb').textContent = (st.hot && st.hot.total_size_mb) ?? 0;
      document.getElementById('warm-count').textContent = warmCount;
      document.getElementById('warm-mb').textContent = (st.warm && st.warm.total_size_mb) ?? 0;
      document.getElementById('cold-count').textContent = coldCount;
      document.getElementById('cold-mb').textContent = (st.cold && st.cold.total_size_mb) ?? 0;
      document.getElementById('total-cost').textContent = '$' + (Number(co.total_cost) || 0).toFixed(2);
      document.getElementById('total-gb').textContent = (Number(co.total_size_gb) || 0).toFixed(2);
      const total = hotCount + warmCount + coldCount;
      document.getElementById('empty-hint').style.display = total === 0 ? 'block' : 'none';
      var lu = document.getElementById('last-updated');
      if (lu) lu.textContent = lastUpdated ? 'Last updated: ' + lastUpdated.toLocaleTimeString() : '';

      const tb = (id, rows) => {
        var tbody = document.querySelector('#' + id + ' tbody');
        if (tbody) tbody.innerHTML = rows.map(function(r) { return r; }).join('');
      };
      tb('logs-table', data.logs.map(function(l) {
        return '<tr><td>' + (l.source || '') + '</td><td><span class="tag ' + (l.level === 'error' ? 'red' : l.level === 'warning' ? 'orange' : 'blue') + '">' + (l.level || '') + '</span></td><td>' + (l.message || '').slice(0, 60) + '</td><td><span class="tag green">' + (l.storage_tier || '') + '</span></td><td>' + (l.timestamp ? new Date(l.timestamp).toLocaleString() : '') + '</td></tr>';
      }));
      tb('jobs-table', data.jobs.map(function(j) {
        return '<tr><td>' + j.id + '</td><td>' + (j.job_type || '') + '</td><td><span class="tag ' + (j.status === 'completed' ? 'green' : j.status === 'failed' ? 'red' : 'blue') + '">' + (j.status || '') + '</span></td><td>' + (j.source_tier || '') + ' → ' + (j.target_tier || '') + '</td><td>' + (j.log_count || 0) + '</td><td>' + (j.started_at ? new Date(j.started_at).toLocaleString() : '') + '</td></tr>';
      }));
      tb('policies-table', data.policies.map(function(p) {
        return '<tr><td>' + (p.name || '') + '</td><td>' + (p.hot_retention_days ?? '') + '</td><td>' + (p.warm_retention_days ?? '') + '</td><td>' + (p.cold_retention_days ?? '') + '</td><td>' + (p.enabled ? 'Yes' : 'No') + '</td></tr>';
      }));
      var tiers = co.tiers || {};
      tb('costs-table', ['hot','warm','cold'].map(function(t) {
        var x = tiers[t] || {};
        return '<tr><td>' + t + '</td><td>' + (x.log_count ?? 0) + '</td><td>' + (Number(x.total_size_gb) || 0).toFixed(2) + '</td><td>$' + (Number(x.total_cost) || 0).toFixed(2) + '</td></tr>';
      }));
    }

    document.querySelectorAll('.sidebar a').forEach(a => {
      a.addEventListener('click', function(e) {
        e.preventDefault();
        document.querySelectorAll('.sidebar a').forEach(x => x.classList.remove('active'));
        this.classList.add('active');
        document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
        document.getElementById(this.dataset.page).classList.add('active');
      });
    });

    document.getElementById('btn-generate').addEventListener('click', async function() {
      this.disabled = true;
      try {
        await fetch(API + '/logs/generate?count=100', { method: 'POST' });
        await fetchAll();
      } catch (e) {}
      this.disabled = false;
    });
    document.getElementById('btn-evaluate').addEventListener('click', async function() {
      this.disabled = true;
      try {
        await fetch(API + '/retention/evaluate', { method: 'POST' });
        await fetchAll();
      } catch (e) {}
      this.disabled = false;
    });
    document.getElementById('btn-refresh').addEventListener('click', function() {
      this.disabled = true;
      fetchAll().then(function() { this.disabled = false; }.bind(this));
    });

    fetchAll();
    setInterval(fetchAll, 5000);
  </script>
</body>
</html>
