import subprocess
import json
import os
from typing import List, Dict
from pathlib import Path
import tempfile
import re

class VulnerabilityScanner:
    def __init__(self):
        self.severity_map = {
            "HIGH": "CRITICAL",
            "MEDIUM": "HIGH",
            "LOW": "MEDIUM"
        }
        
    def scan_directory(self, directory_path: str) -> List[Dict]:
        """Scan directory for security vulnerabilities using Bandit"""
        results = []
        
        try:
            # Run Bandit scanner
            cmd = ["bandit", "-r", directory_path, "-f", "json"]
            process = subprocess.run(cmd, capture_output=True, text=True, timeout=300)
            
            if process.stdout:
                bandit_results = json.loads(process.stdout)
                results.extend(self._parse_bandit_results(bandit_results))
            
            # Add custom pattern scanning
            results.extend(self._scan_custom_patterns(directory_path))
            
        except Exception as e:
            print(f"Vulnerability scan error: {str(e)}")
        
        return results
    
    def _parse_bandit_results(self, bandit_results: dict) -> List[Dict]:
        """Parse Bandit JSON output"""
        findings = []
        
        for result in bandit_results.get("results", []):
            finding = {
                "scan_type": "vulnerability",
                "severity": self.severity_map.get(result.get("issue_severity", "LOW"), "LOW"),
                "title": result.get("test_name", "Security Issue"),
                "description": result.get("issue_text", ""),
                "file_path": result.get("filename", ""),
                "line_number": result.get("line_number", 0),
                "cve_id": None,
                "cvss_score": self._severity_to_cvss(result.get("issue_severity", "LOW")),
                "metadata": {
                    "confidence": result.get("issue_confidence", ""),
                    "test_id": result.get("test_id", ""),
                    "code": result.get("code", "")
                }
            }
            findings.append(finding)
        
        return findings
    
    def _scan_custom_patterns(self, directory_path: str) -> List[Dict]:
        """Scan for custom security patterns"""
        findings = []
        patterns = [
            {
                "name": "Hardcoded Credentials",
                "pattern": r'(password|secret|api_key|token)\s*=\s*["\'][^"\']{8,}["\']',
                "severity": "CRITICAL"
            },
            {
                "name": "SQL Injection Risk",
                "pattern": r'execute\([^)]*%s[^)]*\)|cursor\.execute\([^)]*\+[^)]*\)',
                "severity": "HIGH"
            },
            {
                "name": "Weak Cryptography",
                "pattern": r'(MD5|SHA1|DES)\(',
                "severity": "HIGH"
            },
            {
                "name": "Insecure Random",
                "pattern": r'random\.(random|randint|choice)',
                "severity": "MEDIUM"
            }
        ]
        
        for root, dirs, files in os.walk(directory_path):
            for file in files:
                if file.endswith(('.py', '.js', '.java', '.go')):
                    filepath = os.path.join(root, file)
                    try:
                        with open(filepath, 'r', encoding='utf-8', errors='ignore') as f:
                            content = f.read()
                            for line_num, line in enumerate(content.split('\n'), 1):
                                for pattern_def in patterns:
                                    if re.search(pattern_def['pattern'], line):
                                        findings.append({
                                            "scan_type": "vulnerability",
                                            "severity": pattern_def['severity'],
                                            "title": pattern_def['name'],
                                            "description": f"Detected {pattern_def['name']} pattern",
                                            "file_path": filepath,
                                            "line_number": line_num,
                                            "cve_id": None,
                                            "cvss_score": self._severity_to_cvss(pattern_def['severity']),
                                            "metadata": {"pattern": pattern_def['pattern'], "matched_line": line.strip()}
                                        })
                    except Exception as e:
                        continue
        
        return findings
    
    def _severity_to_cvss(self, severity: str) -> float:
        """Convert severity to CVSS score"""
        mapping = {
            "CRITICAL": 9.5,
            "HIGH": 7.5,
            "MEDIUM": 5.0,
            "LOW": 2.5
        }
        return mapping.get(severity, 0.0)
