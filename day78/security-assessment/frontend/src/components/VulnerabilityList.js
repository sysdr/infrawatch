import React, { useState, useEffect } from 'react';
import {
  Paper,
  Table,
  TableBody,
  TableCell,
  TableContainer,
  TableHead,
  TableRow,
  Typography,
  Chip,
  Box,
  IconButton,
  Collapse,
  ToggleButton,
  ToggleButtonGroup,
} from '@mui/material';
import { ExpandMore, ExpandLess } from '@mui/icons-material';
import { securityAPI } from '../services/api';

const VulnerabilityList = () => {
  const [vulnerabilities, setVulnerabilities] = useState([]);
  const [expanded, setExpanded] = useState({});
  const [statusFilter, setStatusFilter] = useState('all');

  useEffect(() => {
    loadVulnerabilities();
    // Auto-refresh every 15 seconds
    const interval = setInterval(loadVulnerabilities, 15000);
    return () => clearInterval(interval);
  }, []);

  const loadVulnerabilities = async () => {
    try {
      const response = await securityAPI.getVulnerabilities(null, 50);
      setVulnerabilities(response.data.vulnerabilities);
    } catch (error) {
      console.error('Failed to load vulnerabilities:', error);
    }
  };

  const getSeverityColor = (severity) => {
    const colors = {
      CRITICAL: 'error',
      HIGH: 'warning',
      MEDIUM: 'info',
      LOW: 'success',
    };
    return colors[severity] || 'default';
  };

  const toggleExpand = (id) => {
    setExpanded(prev => ({ ...prev, [id]: !prev[id] }));
  };

  const filteredVulns = vulnerabilities.filter((vuln) => {
    if (statusFilter === 'all') return true;
    const vulnStatus = (vuln.status || 'open').toLowerCase();
    return vulnStatus === statusFilter.toLowerCase();
  });

  // Count vulnerabilities by status
  const statusCounts = {
    all: vulnerabilities.length,
    open: vulnerabilities.filter(v => (v.status || 'open').toLowerCase() === 'open').length,
    resolved: vulnerabilities.filter(v => (v.status || '').toLowerCase() === 'resolved').length,
  };

  return (
    <Paper sx={{ p: 3 }}>
      <Typography variant="h5" gutterBottom sx={{ fontWeight: 600, mb: 3 }}>
        Vulnerability Findings
      </Typography>
      <Box sx={{ mb: 2, display: 'flex', justifyContent: 'flex-start', gap: 1 }}>
        <ToggleButtonGroup
          size="small"
          value={statusFilter}
          exclusive
          onChange={(event, val) => {
            if (val !== null) {
              setStatusFilter(val);
            }
          }}
          sx={{
            '& .MuiToggleButton-root': {
              '&:hover': {
                backgroundColor: 'rgba(25, 118, 210, 0.08)',
                cursor: 'pointer',
              },
              '&.Mui-selected': {
                backgroundColor: 'rgba(25, 118, 210, 0.12)',
                '&:hover': {
                  backgroundColor: 'rgba(25, 118, 210, 0.16)',
                },
              },
            },
          }}
        >
          <ToggleButton value="all" aria-label="all">
            All ({statusCounts.all})
          </ToggleButton>
          <ToggleButton value="open" aria-label="open">
            Open ({statusCounts.open})
          </ToggleButton>
          <ToggleButton value="resolved" aria-label="resolved">
            Resolved ({statusCounts.resolved})
          </ToggleButton>
        </ToggleButtonGroup>
      </Box>
      <TableContainer>
        <Table>
          <TableHead>
            <TableRow sx={{ bgcolor: '#f5f5f5' }}>
              <TableCell width={50}></TableCell>
              <TableCell><strong>Severity</strong></TableCell>
              <TableCell><strong>Title</strong></TableCell>
              <TableCell><strong>File</strong></TableCell>
              <TableCell><strong>CVE</strong></TableCell>
              <TableCell><strong>CVSS</strong></TableCell>
              <TableCell><strong>Status</strong></TableCell>
            </TableRow>
          </TableHead>
          <TableBody>
            {filteredVulns.map((vuln) => (
              <React.Fragment key={vuln.id}>
                <TableRow hover>
                  <TableCell>
                    <IconButton size="small" onClick={() => toggleExpand(vuln.id)}>
                      {expanded[vuln.id] ? <ExpandLess /> : <ExpandMore />}
                    </IconButton>
                  </TableCell>
                  <TableCell>
                    <Chip
                      label={vuln.severity}
                      color={getSeverityColor(vuln.severity)}
                      size="small"
                    />
                  </TableCell>
                  <TableCell>{vuln.title}</TableCell>
                  <TableCell sx={{ fontSize: '0.85rem', color: 'text.secondary' }}>
                    {vuln.file_path?.split('/').pop() || 'N/A'}
                    {vuln.line_number && `:${vuln.line_number}`}
                  </TableCell>
                  <TableCell>{vuln.cve_id || '-'}</TableCell>
                  <TableCell>{vuln.cvss_score?.toFixed(1) || '-'}</TableCell>
                  <TableCell>
                    <Chip
                      label={vuln.status}
                      size="small"
                      variant="outlined"
                      color={vuln.status === 'open' ? 'warning' : 'success'}
                    />
                  </TableCell>
                </TableRow>
                <TableRow>
                  <TableCell colSpan={7} sx={{ py: 0 }}>
                    <Collapse in={expanded[vuln.id]} timeout="auto" unmountOnExit>
                      <Box sx={{ p: 2, bgcolor: '#f9f9f9', borderRadius: 1, my: 1 }}>
                        <Typography variant="subtitle2" gutterBottom>
                          <strong>Description:</strong>
                        </Typography>
                        <Typography variant="body2" color="text.secondary" paragraph>
                          {vuln.description}
                        </Typography>
                        <Typography variant="caption" color="text.secondary">
                          Detected: {new Date(vuln.created_at).toLocaleString()}
                        </Typography>
                      </Box>
                    </Collapse>
                  </TableCell>
                </TableRow>
              </React.Fragment>
            ))}
          </TableBody>
        </Table>
      </TableContainer>
    </Paper>
  );
};

export default VulnerabilityList;
