<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>DB Optimization Dashboard</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; }
    body { font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif; background: #f0f2f5; color: #1a1a2e; padding: 20px; line-height: 1.4; }
    .header { background: #1b4332; color: white; padding: 16px 24px; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.15); display: flex; align-items: center; justify-content: space-between; flex-wrap: wrap; gap: 12px; }
    .header h1 { font-size: 22px; font-weight: 700; }
    .header .sub { color: #74c69d; font-size: 12px; }
    .status { padding: 12px 16px; border-radius: 8px; margin-bottom: 20px; font-size: 14px; }
    .status.loading { background: #e8f5e9; color: #2e7d32; }
    .status.ok { background: #d8f3dc; color: #1b4332; }
    .status.fail { background: #fde8e8; color: #c62828; }
    .cards { display: grid; grid-template-columns: repeat(auto-fill, minmax(200px, 1fr)); gap: 12px; margin-bottom: 24px; }
    .card { background: white; border-radius: 10px; padding: 16px; box-shadow: 0 1px 4px rgba(0,0,0,0.08); border-left: 4px solid #52b788; }
    .card h3 { font-size: 11px; color: #74c69d; text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; }
    .card .v { font-size: 24px; font-weight: 700; color: #1b4332; }
    .card.err { border-left-color: #e63946; }
    .card .v.err { color: #e63946; }
    .section { background: white; border-radius: 10px; padding: 16px; margin-bottom: 16px; box-shadow: 0 1px 4px rgba(0,0,0,0.08); }
    .section h2 { font-size: 14px; color: #1b4332; margin-bottom: 12px; text-transform: uppercase; letter-spacing: 0.5px; }
    pre { background: #f5f5f5; padding: 12px; border-radius: 6px; overflow: auto; font-size: 12px; }
    table { width: 100%; border-collapse: collapse; font-size: 13px; }
    th, td { padding: 8px 12px; text-align: left; border-bottom: 1px solid #eee; }
    th { color: #74c69d; font-weight: 600; }
  </style>
</head>
<body>
  <div class="header">
    <div>
      <h1>DB Optimization Dashboard</h1>
    </div>
    <span class="sub" id="lastRefresh"></span>
  </div>

  <div id="status" class="status loading">Checking API...</div>
  <div id="cards" class="cards"></div>
  <div id="extra" class="section" style="display:none;">
    <h2>API health</h2>
    <pre id="health"></pre>
  </div>

  <script>
    (function() {
      var API = 'http://localhost:8000';
      var statusEl = document.getElementById('status');
      var cardsEl = document.getElementById('cards');
      var healthEl = document.getElementById('health');
      var lastRefreshEl = document.getElementById('lastRefresh');
      var extraEl = document.getElementById('extra');

      function safeJson(res) {
        return res.json().then(function(j) { return j; }).catch(function() { return {}; });
      }

      function renderCards(items) {
        if (!items || items.length === 0) return;
        cardsEl.innerHTML = items.map(function(i) {
          var errClass = i.err ? ' err' : '';
          return '<div class="card' + errClass + '"><h3>' + i.label + '</h3><div class="v' + errClass + '">' + (i.value != null ? i.value : '—') + '</div></div>';
        }).join('');
      }

      function check() {
        fetch(API + '/health', { mode: 'cors' }).then(function(r) {
          return safeJson(r).then(function(j) {
            healthEl.textContent = JSON.stringify(j, null, 2);
            extraEl.style.display = 'block';
            if (r.ok) {
              statusEl.textContent = 'API connected. Database: ' + (j.db || 'connected');
              statusEl.className = 'status ok';
              loadSummary();
            } else {
              statusEl.textContent = 'API returned ' + r.status + '. Start PostgreSQL for full metrics.';
              statusEl.className = 'status fail';
              renderCards([{ label: 'Health', value: r.status, err: true }]);
            }
          });
        }).catch(function(e) {
          statusEl.textContent = 'Cannot reach API at ' + API + '. Ensure backend is running (port 8000).';
          statusEl.className = 'status fail';
          healthEl.textContent = String(e);
          extraEl.style.display = 'block';
          renderCards([{ label: 'Error', value: e.message || 'Network error', err: true }]);
        });
      }

      function loadSummary() {
        fetch(API + '/api/dashboard/summary', { mode: 'cors' }).then(function(r) {
          return safeJson(r).then(function(d) {
            lastRefreshEl.textContent = 'Last: ' + new Date().toLocaleTimeString();
            if (r.ok && d && typeof d.avg_query_latency_ms === 'number') {
              renderCards([
                { label: 'Avg latency (ms)', value: d.avg_query_latency_ms },
                { label: 'Slow queries', value: d.slow_query_count },
                { label: 'Replica lag (ms)', value: d.replica_lag_ms < 1 ? '<1' : d.replica_lag_ms },
                { label: 'Connections %', value: d.connection_utilization_pct + '%' }
              ]);
            } else {
              renderCards([
                { label: 'Avg latency', value: '—' },
                { label: 'Slow queries', value: '—' },
                { label: 'Replica lag', value: '—' },
                { label: 'Connections %', value: '—' }
              ]);
            }
          });
        }).catch(function() {
          lastRefreshEl.textContent = 'Last: ' + new Date().toLocaleTimeString();
          renderCards([
            { label: 'Avg latency', value: '—' },
            { label: 'Slow queries', value: '—' },
            { label: 'Replica lag', value: '—' },
            { label: 'Connections %', value: '—' }
          ]);
        });
      }

      check();
      setInterval(check, 5000);
    })();
  </script>
</body>
</html>
